<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [WSJT-SVN] r2898 - in branches/wsprx: . lib
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/wsjt-svn/2013-January/index.html" >
   <LINK REL="made" HREF="mailto:wsjt-svn%40lists.berlios.de?Subject=Re%3A%20%5BWSJT-SVN%5D%20r2898%20-%20in%20branches/wsprx%3A%20.%20lib&In-Reply-To=%3C20130108144914.EB47F55B0C%40scm.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002589.html">
   <LINK REL="Next"  HREF="002591.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[WSJT-SVN] r2898 - in branches/wsprx: . lib</H1>
    <B>k1jt at scm.berlios.de</B> 
    <A HREF="mailto:wsjt-svn%40lists.berlios.de?Subject=Re%3A%20%5BWSJT-SVN%5D%20r2898%20-%20in%20branches/wsprx%3A%20.%20lib&In-Reply-To=%3C20130108144914.EB47F55B0C%40scm.berlios.de%3E"
       TITLE="[WSJT-SVN] r2898 - in branches/wsprx: . lib">k1jt at scm.berlios.de
       </A><BR>
    <I>Tue Jan  8 15:49:14 CET 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="002589.html">[WSJT-SVN] r2897 - in branches/wsprx: . lib
</A></li>
        <LI>Next message: <A HREF="002591.html">[WSJT-SVN] r2899 - branches/wsprx
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2590">[ date ]</a>
              <a href="thread.html#2590">[ thread ]</a>
              <a href="subject.html#2590">[ subject ]</a>
              <a href="author.html#2590">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: k1jt
Date: 2013-01-08 15:49:14 +0100 (Tue, 08 Jan 2013)
New Revision: 2898

Added:
   branches/wsprx/lib/mept162a.f90
   branches/wsprx/lib/mix162a.f90
   branches/wsprx/lib/wsprd.f90
Removed:
   branches/wsprx/lib/genmept.f90
   branches/wsprx/lib/getutc.f90
   branches/wsprx/lib/gmtime2.c
   branches/wsprx/lib/gran.c
   branches/wsprx/lib/mept162.f90
   branches/wsprx/lib/sound.c
   branches/wsprx/lib/spec162.f90
   branches/wsprx/lib/wfile5.f90
   branches/wsprx/lib/wspr0_rx.f90
   branches/wsprx/lib/wspr0_tx.f90
Modified:
   branches/wsprx/lib/Makefile
   branches/wsprx/lib/genwsprx.f90
   branches/wsprx/lib/savec2.f90
   branches/wsprx/lib/wqdecode.f90
   branches/wsprx/mainwindow.cpp
Log:
Major cleanup of lib directory; installation of wsprd as decoder.


Modified: branches/wsprx/lib/Makefile
===================================================================
--- branches/wsprx/lib/Makefile	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/Makefile	2013-01-08 14:49:14 UTC (rev 2898)
@@ -5,7 +5,7 @@
 CC = gcc
 FC = g95
 
-FFLAGS = -O2 -fbounds-check -Wall -Wno-precision-loss -ftrace=frame
+FFLAGS = -O2 -fbounds-check -Wall -Wno-precision-loss 
 #CFLAGS = -I. -fbounds-check -mno-stack-arg-probe
 CFLAGS = -I. -fbounds-check 
 
@@ -21,17 +21,15 @@
 %.o: %.F90
 	${FC} ${FFLAGS} -c $&lt;
 
-all:    libwspr.a wspr0.exe
+all:    libwspr.a wsprd.exe
 
-OBJS1 = symspec.o timf2.o fil3.o wspr0_tx.o sound.o ptt.o gmtime2.o \
-	wfile5.o genmept.o wqencode.o wqdecode.o inter_mept.o \
-	encode232.o gran.o packcall.o packgrid.o pack50.o packpfx.o \
-	hash.o unpackcall.o unpackgrid.o unpackpfx.o unpack50.o \
-	grid2deg.o deg2grid.o nhash.o nchar.o wspr0_rx.o getrms.o \
-	mept162.o mix162.o spec162.o sync162.o twkfreq.o \
-	decode162.o getutc.o set.o xfft.o four2a.o flat3.o ps162.o \
-	pctile.o fchisq.o db.o fano232.o sort.o ssort.o ccf2.o \
-	genwsprx.o savec2.o
+OBJS1 = ccf2.o db.o decode162.o deg2grid.o encode232.o fano232.o \
+	fchisq.o fil3.o flat3.o four2a.o genwsprx.o getrms.o \
+	grid2deg.o hash.o inter_mept.o mept162a.o mix162.o mix162a.o \
+	nchar.o nhash.o pack50.o packcall.o packgrid.o packpfx.o \
+	pctile.o ps162.o ptt.o savec2.o set.o sort.o ssort.o symspec.o \
+	sync162.o timf2.o twkfreq.o unpack50.o unpackcall.o \
+	unpackgrid.o unpackpfx.o wqdecode.o wqencode.o xfft.o 
 
 libwspr.a: $(OBJS1)
 	ar cr libwspr.a $(OBJS1) 
@@ -39,17 +37,11 @@
 
 OBJS2 = wspr0.o 
 
-wspr0.exe: $(OBJS2) libwspr.a
-	$(FC) -o wspr0 $(FFLAGS) $(OBJS2) libwspr.a libportaudio.a \
-	   c:\MinGW\lib\libwinmm.a libfftw3f_win.a
-	cp wspr0.exe ../../wsprx_install
+wsprd.exe: wsprd.o libwspr.a
+	$(FC) -o wsprd.exe $(FFLAGS) wsprd.o libwspr.a libfftw3f_win.a
+	cp wsprd.exe ../../wsprx_install
 
-sound.o: sound.c
-	$(CC) -c sound.c
-gmtime2.o: gmtime2.c
-	$(CC) -c -DWin32=1 gmtime2.c
-
 .PHONY : clean
 
 clean:
-	rm -f *.o libwspr.a wspr0.exe
+	rm -f *.o libwspr.a wsprd.exe

Deleted: branches/wsprx/lib/genmept.f90
===================================================================
--- branches/wsprx/lib/genmept.f90	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/genmept.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -1,101 +0,0 @@
-subroutine genmept(message,ntxdf,snrdb,iwave)
-
-! Encode a WSPR message and generate the corresponding wavefile.
-
-  character*22 message
-  parameter (NMAX=120*12000)     !Max length of wave file
-  integer*2 iwave(NMAX)          !Generated wave file
-  parameter (MAXSYM=176)
-  integer*1 symbol(MAXSYM)
-  integer*1 data0(11),i1
-  integer npr3(162)
-  logical first
-  real*8 t,dt,phi,f,f0,dfgen,dphi,pi,twopi,tsymbol
-  equivalence(i1,i4)
-  data npr3/                                      &amp;
-      1,1,0,0,0,0,0,0,1,0,0,0,1,1,1,0,0,0,1,0,    &amp;
-      0,1,0,1,1,1,1,0,0,0,0,0,0,0,1,0,0,1,0,1,    &amp;
-      0,0,0,0,0,0,1,0,1,1,0,0,1,1,0,1,0,0,0,1,    &amp;
-      1,0,1,0,0,0,0,1,1,0,1,0,1,0,1,0,1,0,0,1,    &amp;
-      0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,0,0,0,1,0,    &amp;
-      0,0,0,0,1,0,0,1,0,0,1,1,1,0,1,1,0,0,1,1,    &amp;
-      0,1,0,0,0,1,1,1,0,0,0,0,0,1,0,1,0,0,1,1,    &amp;
-      0,0,0,0,0,0,0,1,1,0,1,0,1,1,0,0,0,1,1,0,    &amp;
-      0,0/
-
-  data first/.true./,idum/0/
-  save
-
-  if(first) then
-     pi=4.d0*atan(1.d0)
-     twopi=2.d0*pi
-     first=.false.
-  endif
-
-  call wqencode(message,ntype,data0)
-  nbytes=(50+31+7)/8
-  call encode232(data0,nbytes,symbol,MAXSYM)  !Convolutional encoding
-  call inter_mept(symbol,1)                   !Apply interleaving
-  do i=1,162
-     i4=0
-     i1=symbol(i)
-  enddo
-
-! Set up necessary constants
-  tsymbol=8192.d0/12000.d0
-  dt=1.d0/12000.d0
-  f0=1500 + ntxdf
-  dfgen=12000.d0/8192.d0                     !1.4649 Hz
-  nsigs=1
-  if(snrdb.eq.10.0) nsigs=10
-  do isig=1,nsigs
-     if(nsigs.eq.1) snr=10.0**(0.05*(snrdb-1))   !Bandwidth correction?
-     fac=3000.0
-     if(snr.gt.1.0) fac=3000.0/snr
-     if(nsigs.eq.10) then
-        snr=10.0**(0.05*(-20-isig))
-        f0=1390 + 20*isig
-     endif
-     t=-2.d0 - 0.1*(isig-1)
-     phi=0.d0
-     j0=0
-
-     do i=1,NMAX
-        t=t+dt
-        j=int(t/tsymbol) + 1                          !Symbol number
-        sig=0.
-        if(j.ge.1 .and. j.le.162) then
-           if(j.ne.j0) then
-              f=f0 + dfgen*(npr3(j)+2*symbol(j)-1.5)
-              j0=j
-              if(snrdb.eq.11.0) then
-                 k=npr3(j) + 2*symbol(j)
-                 write(*,1000) j,k,f
-1000             format(i3,i3,f10.3)
-                 go to 10
-              else
-                 dphi=twopi*dt*f
-              endif
-           endif
-           sig=0.9999
-        endif
-        phi=phi+dphi
-        if(snrdb.gt.50.0) then
-           n=32767.0*sin(phi)           !Normal transmission, signal only
-        else
-           if(isig.eq.1) then
-              n=fac*(gran(idum) + sig*snr*sin(phi))
-           else
-              n=iwave(i) + fac*sig*snr*sin(phi)
-           endif
-           if(n.gt.32767) n=32767
-           if(n.lt.-32767) n=-32767
-        endif
-        iwave(i)=n
-10      continue
-     enddo
-  enddo
-
-  return
-end subroutine genmept
-

Modified: branches/wsprx/lib/genwsprx.f90
===================================================================
--- branches/wsprx/lib/genwsprx.f90	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/genwsprx.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -5,7 +5,7 @@
   character*22 message
   parameter (MAXSYM=176)
   integer*1 symbol(MAXSYM)
-  integer*1 data0(11),i1
+  integer*1 data0(11)
   integer*4 itone(162)
   integer npr3(162)
   data npr3/                                      &amp;

Deleted: branches/wsprx/lib/getutc.f90
===================================================================
--- branches/wsprx/lib/getutc.f90	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/getutc.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -1,32 +0,0 @@
-subroutine getutc(cdate,ctime,tsec)
-
-  character cdate*8,ctime*10
-  real*8 tsec
-  integer nt(9)
-!        1    2    3    4     5    6    7    8   9
-!  nt:  sec  min  ihr  day  month year dweek 0   0
-
-  call gmtime2(nt,tsec)
-  cdate(1:1)=char(48+nt(6)/1000)
-  cdate(2:2)=char(48+mod(nt(6),1000)/100)
-  cdate(3:3)=char(48+mod(nt(6),100)/10)
-  cdate(4:4)=char(48+mod(nt(6),10))
-  cdate(5:5)=char(48+nt(5)/10)
-  cdate(6:6)=char(48+mod(nt(5),10))
-  cdate(7:7)=char(48+nt(4)/10)
-  cdate(8:8)=char(48+mod(nt(4),10))
-  ctime(1:1)=char(48+nt(3)/10)
-  ctime(2:2)=char(48+mod(nt(3),10))
-  ctime(3:3)=char(48+nt(2)/10)
-  ctime(4:4)=char(48+mod(nt(2),10))
-  ctime(5:5)=char(48+nt(1)/10)
-  ctime(6:6)=char(48+mod(nt(1),10))
-  ctime(7:7)='.'
-  nsec=tsec
-  msec=1000*(tsec-nsec)
-  ctime(8:8)=char(48+msec/100)
-  ctime(9:9)=char(48+mod(msec,100)/10)
-  ctime(10:10)=char(48+mod(msec,10))
-
-  return
-end subroutine getutc

Deleted: branches/wsprx/lib/gmtime2.c
===================================================================
--- branches/wsprx/lib/gmtime2.c	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/gmtime2.c	2013-01-08 14:49:14 UTC (rev 2898)
@@ -1,54 +0,0 @@
-#include &lt;stdio.h&gt;
-#include &lt;string.h&gt;
-
-typedef struct _SYSTEMTIME
-{
-  short   Year;
-  short   Month;
-  short   DayOfWeek;
-  short   Day;
-  short   Hour;
-  short   Minute;
-  short   Second;
-  short   Millisecond;
-} SYSTEMTIME;
-
-#ifdef Win32
-extern void __stdcall GetSystemTime(SYSTEMTIME *st);
-#else
-#include &lt;sys/time.h&gt;
-#include &lt;time.h&gt;
-
-void GetSystemTime(SYSTEMTIME *st){
-  struct timeval tmptimeofday;
-  struct tm tmptmtime;
-  gettimeofday(&amp;tmptimeofday,NULL);
-  gmtime_r((const time_t *)&amp;tmptimeofday.tv_sec,&amp;tmptmtime);
-  st-&gt;Year = (short)tmptmtime.tm_year;
-  st-&gt;Month = (short)tmptmtime.tm_mon+1;
-  st-&gt;DayOfWeek = (short)tmptmtime.tm_wday;
-  st-&gt;Day = (short)tmptmtime.tm_mday;
-  st-&gt;Hour = (short)tmptmtime.tm_hour;
-  st-&gt;Minute = (short)tmptmtime.tm_min;
-  st-&gt;Second = (short)tmptmtime.tm_sec;
-  st-&gt;Millisecond = (short)(tmptimeofday.tv_usec/1000);
-}
-#endif
-
-extern void gmtime2_(int it[], double *stime)
-{
-  SYSTEMTIME st;
-
-  GetSystemTime(&amp;st);
-  it[0]=st.Second;
-  it[1]=st.Minute;
-  it[2]=st.Hour;
-  it[3]=st.Day;
-  it[4]=st.Month;
-  it[5]=st.Year;
-  it[6]=st.DayOfWeek;
-  it[7]=0;
-  it[8]=0;
-  *stime = st.Hour*3600.0 + st.Minute*60.0 + st.Second + st.Millisecond*0.001;
-}
-

Deleted: branches/wsprx/lib/gran.c
===================================================================
--- branches/wsprx/lib/gran.c	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/gran.c	2013-01-08 14:49:14 UTC (rev 2898)
@@ -1,28 +0,0 @@
-#include &lt;stdlib.h&gt;
-#include &lt;math.h&gt;
-
-/* Generate gaussian random float with mean=0 and std_dev=1 */
-float gran_()
-{
-  float fac,rsq,v1,v2;
-  static float gset;
-  static int iset;
-
-  if(iset){
-    /* Already got one */
-    iset = 0;
-    return gset;
-  }
-  /* Generate two evenly distributed numbers between -1 and +1
-   * that are inside the unit circle
-   */
-  do {
-    v1 = 2.0 * (float)rand() / RAND_MAX - 1;
-    v2 = 2.0 * (float)rand() / RAND_MAX - 1;
-    rsq = v1*v1 + v2*v2;
-  } while(rsq &gt;= 1.0 || rsq == 0.0);
-  fac = sqrt(-2.0*log(rsq)/rsq);
-  gset = v1*fac;
-  iset++;
-  return v2*fac;
-}

Deleted: branches/wsprx/lib/mept162.f90
===================================================================
--- branches/wsprx/lib/mept162.f90	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/mept162.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -1,107 +0,0 @@
-subroutine mept162(outfile,appdir,nappdir,f0,ncmdline,id,npts,nbfo,ierr)
-
-! Orchestrates the process of finding, synchronizing, and decoding 
-! WSPR signals.
-
-  integer*2 id(npts)
-  character*22 message
-  character*80 outfile,appdir,alltxt
-  character*11 datetime
-  character cdate*8,ctime*10
-  real*8 f0,freq,tsec
-  real ps(-256:256)
-  real sstf(5,275)
-  real a(5)
-  complex c2(65536)
-  complex c3(45000),c4(45000)
-
-! Mix from &quot;nbfo&quot; +/- 100 Hz to baseband, and downsample by 1/32
-  call mix162(id,npts,nbfo,c2,jz,ps)
-
-  if(ncmdline.eq.0) then
-! Compute pixmap.dat
-     call spec162(c2,jz,appdir,nappdir)
-  endif
-
-! Look for sync patterns, get DF and DT
-  call sync162(c2,jz,ps,sstf,kz)
-  ierr = 0
-  if(kz.eq.0) go to 900
-  if (kz.gt.275 .or. kz.lt.0) then
-     call getutc(cdate,ctime,tsec)
-     write(*,1000) ctime,kz
-1000 format('Time ',a8,'. Error from sync162: kz is',i10)
-     ierr = 1
-     return
-  endif
-  do k=1,kz
-     snrsync=sstf(1,k)
-     snrx=sstf(2,k)
-     dtx=sstf(3,k)
-     dfx=sstf(4,k)
-     drift=sstf(5,k)
-     a(1)=-dfx
-     a(2)=-0.5*drift
-     a(3)=0.
-     call twkfreq(c2,c3,jz,a)                    !Remove drift
-
-     minsync=1                                   !####
-     nsync=nint(snrsync)
-     nsnrx=nint(snrx)
-     if(nsnrx.lt.-33) nsnrx=-33
-     if(nsync.lt.0) nsync=0
-     freq=f0 + 1.d-6*(dfx+nbfo)
-     message='                      '
-     if(nsync.ge.minsync .and. nsnrx.ge.-33) then      !### -31 dB limit?
-
-        dt=1.0/375
-        do idt=0,128
-           ii=(idt+1)/2
-           if(mod(idt,2).eq.1) ii=-ii
-           i1=nint((dtx+2.0)/dt) + ii !Start index for synced symbols
-           if(i1.ge.1) then
-! Fix this earlier!
-              c4(1:jz-i1+1)=c3(i1:)
-              c4(jz-i1+2:)=0.
-           else
-              c4(:-i1+1)=0.
-              c4(-i1+2:jz)=c3(:i1+jz-1)
-              if(jz.lt.45000) c4(jz:)=0.
-           endif
-           call decode162(c4,45000,message,ncycles,metric,nerr)
-           if(message(1:6).ne.'      ' .and. message(1:6).ne.'000AAA' .and. &amp;
-                index(message,'A000AA').le.0) go to 23
-        enddo
-        go to 24
-
-23      i2=index(outfile,'.wav')-1
-        if(i2.le.0) i2=index(outfile,'.WAV')-1
-        datetime=outfile(max(1,i2-10):i2)
-        datetime(7:7)=' '
-        nf1=nint(-a(2))
-        alltxt=appdir(:nappdir)//'/ALL_WSPR.TXT'
-
-        if(ncmdline.eq.0) then
-           open(13,file=alltxt,status='unknown',position='append')
-           write(13,1010) datetime,nsync,nsnrx,dtx,freq,message,nf1,    &amp;
-                ncycles/81,ii
-           close(13)
-        else
-           write(*,1008) datetime(8:11),nsnrx,dtx,freq,nf1,message
-1008       format(a4,i4,f5.1,f11.6,i3,2x,a22)
-        endif
-        write(14,1010) datetime,nsync,nsnrx,dtx,freq,message,nf1,       &amp;
-             ncycles/81,ii
-1010    format(a11,i4,i4,f5.1,f11.6,2x,a22,i3,i6,i5)
-        call flush(14)
-        open(17,file='wspr0.out',status='unknown',position='append')
-        write(17,1010) datetime,nsync,nsnrx,dtx,freq,message,nf1,ncycles/81,ii
-        close(17)
-        i1=index(message,' ')
-
-     endif
-24   continue
-  enddo
-
-900 return
-end subroutine mept162

Added: branches/wsprx/lib/mept162a.f90
===================================================================
--- branches/wsprx/lib/mept162a.f90	                        (rev 0)
+++ branches/wsprx/lib/mept162a.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -0,0 +1,86 @@
+subroutine mept162a(datetime,f0,c2,ps,lc2,npts,nbfo)
+
+! Orchestrates the process of finding, synchronizing, and decoding 
+! WSPR signals.
+
+  logical lc2
+  character*22 message
+  character*11 datetime
+  real*8 f0,freq
+  real ps(-256:256)
+  real sstf(5,275)
+  real a(5)
+  complex c2(65536)
+  complex c3(45000),c4(45000)
+
+  jz=45000
+  c2(jz+1:)=0.
+
+  call sync162(c2,jz,ps,sstf,kz)        !Look for sync patterns, get DF and DT
+
+  if(kz.eq.0) go to 900
+  do k=1,kz
+     snrsync=sstf(1,k)
+     snrx=sstf(2,k)
+     dtx=sstf(3,k)
+     dfx=sstf(4,k)
+     drift=sstf(5,k)
+     a(1)=-dfx
+     a(2)=-0.5*drift
+     a(3)=0.
+     call twkfreq(c2,c3,jz,a)                    !Remove drift
+
+     minsync=1                                   !####
+     nsync=nint(snrsync)
+     if(nsync.lt.0) nsync=0
+     if(npts.le.120*12000) then
+        minsnr=-33
+        nsnrx=nint(snrx)                         !WSPR-2
+        if(nsnrx.lt.minsnr) nsnrx=minsnr
+        freq=f0 + 1.d-6*(dfx+nbfo)
+     else
+        minsnr=-42
+        nsnrx=nint(snrx-9.0)                     !WSPR-15
+        if(nsnrx.lt.minsnr) nsnrx=minsnr
+        dfx=dfx/8
+        freq=f0 + 1.d-6*(dfx+nbfo+112.5d0)
+     endif
+     message='                      '
+     if(nsync.ge.minsync .and. nsnrx.ge.minsnr) then
+        dt=1.0/375
+        do idt=0,128
+           ii=(idt+1)/2
+           if(mod(idt,2).eq.1) ii=-ii
+           i1=nint((dtx+2.0)/dt) + ii !Start index for synced symbols
+           if(i1.ge.1) then
+!  Fix this earlier!
+              c4(1:jz-i1+1)=c3(i1:)
+              c4(jz-i1+2:)=0.
+           else
+              c4(:-i1+1)=0.
+              c4(-i1+2:jz)=c3(:i1+jz-1)
+              if(jz.lt.45000) c4(jz:)=0.
+           endif
+           call decode162(c4,45000,message,ncycles,metric,nerr)
+           if(message(1:6).ne.'      ' .and.                        &amp;
+                message(1:6).ne.'000AAA' .and.                      &amp;
+                index(message,'A000AA').le.0) then
+              nf1=nint(-a(2))
+              if(npts.gt.120*12000) dtx=8*(dtx + 1.8)   !1.8 is empirical ###
+
+              write(13,1010) datetime,nsync,nsnrx,dtx,freq,message,nf1,   &amp;
+                   ncycles/81,ii
+1010          format(a11,i4,i4,f5.1,f11.6,2x,a22,i3,i6,i5)
+              write(*,1020) datetime(8:11),nsnrx,dtx,freq,nf1,message
+1020          format(a4,i4,f5.1,f11.6,i3,2x,a22)
+              write(14,1010) datetime,nsync,nsnrx,dtx,freq,message,nf1,      &amp;
+                   ncycles/81,ii
+              call flush(14)
+              exit
+           endif
+        enddo
+     endif
+  enddo
+
+900 return
+end subroutine mept162a

Added: branches/wsprx/lib/mix162a.f90
===================================================================
--- branches/wsprx/lib/mix162a.f90	                        (rev 0)
+++ branches/wsprx/lib/mix162a.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -0,0 +1,28 @@
+subroutine mix162a(c2,ps)
+
+  real ps(-256:256)
+  complex c2(0:65535),c2a(0:65535)
+
+  c2=conjg(c2)
+  c2a(0:45000-1)=c2(0:45000-1)
+  c2a(45000:)=0.
+  nfft2=65536
+  nh2=nfft2/2
+  call four2a(c2a,nfft2,1,-1,1)
+  
+  ia=1-nh2
+  ib=nh2
+
+  k=-257
+  do i=ia-64,ib,128
+     k=k+1
+     sq=0.
+     do n=0,127
+        j=mod(i+n+4*nfft2,nfft2)
+        sq=sq + real(c2a(j))**2 + aimag(c2a(j))**2
+     enddo
+     ps(k)=4.085e-8*sq * 10.0**(-0.98)
+  enddo
+
+  return
+end subroutine mix162a

Modified: branches/wsprx/lib/savec2.f90
===================================================================
--- branches/wsprx/lib/savec2.f90	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/savec2.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -1,54 +1,21 @@
-subroutine savec2(c2name,ntrseconds,dialFreq)
+subroutine savec2(fname,ntrseconds,dialFreq)
 
-! Array c0() has complex samples at 1500 Hz sample rate.
-! WSPR-2:  downsample by 1/4 to produce c2(45000), centered at 1500 Hz
-! WSPR-15: downsample by 1/32 to produce c2(45000), centered at 1612.5 Hz
-
   parameter (NMAX=900*12000)         !Total sample intervals per 30 minutes
   parameter (NDMAX=900*1500)         !Sample intervals at 1500 Hz rate
   parameter (NSMAX=1366)             !Max length of saved spectra
-  parameter (MAXFFT=2048*1024)
-
-  character*(*) c2name
-  character*14 outfile
+  character*(*) fname
+  character c2file*14
   real*8 dialFreq
-  integer*2 id2
   complex c0
-  complex c1(0:MAXFFT-1)
-  complex c2(0:65535)
-  common/datcom/nutc,ndiskdat,id2(NMAX),savg(NSMAX),c0(0:NDMAX-1)
+  common/datcom/nutc,ndiskdat,id2(NMAX),savg(NSMAX),c0(NDMAX)
 
-  ntrminutes=ntrseconds/60
-  npts=114*1500
-  nfft1=262144
-  if(ntrminutes.eq.15) then
-     npts=890*1500
-     nfft1=MAXFFT
-  endif
-  df1=1500.0/nfft1
-  fac=1.0/nfft1
-  c1(0:npts-1)=fac*c0(0:npts-1)
-  c1(npts:nfft1-1)=0.
+  open(18,file=fname,status='unknown',access='stream')
 
-  call four2a(c1,nfft1,1,1,1)
-
-  nfft2=65536
-  nh2=nfft2/2
-  if(ntrminutes.eq.2) then
-     c2(0:nh2)=c1(0:nh2)
-     c2(nh2+1:nfft2-1)=c1(nfft1-nh2+1:nfft1-1)
-  else
-     i0=nint(112.5/df1)
-     c2(0:nh2)=c1(i0:i0+nh2)
-     c2(nh2+1:nfft2-1)=c1(i0-nh2+1:i0-1)
-  endif
-
-  call four2a(c2,nfft2,1,-1,1)
-
-  i1=index(c2name,'.c2')
-  outfile=c2name(i1-11:i1+2)
-  open(18,file=c2name,status='unknown',access='stream')
-  write(18) outfile,ntrminutes,dialFreq,c2(0:45000-1)
+  i1=index(fname,'.c2')
+  c2file=fname(i1-11:i1+2)
+  ntrminutes=ntrseconds/60
+  print*,'a ',c2file,ntrminutes,dialFreq
+  write(18) c2file,ntrminutes,dialFreq,c0(1:45000)
   close(18)
 
   return

Deleted: branches/wsprx/lib/sound.c
===================================================================
--- branches/wsprx/lib/sound.c	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/sound.c	2013-01-08 14:49:14 UTC (rev 2898)
@@ -1,154 +0,0 @@
-#include &lt;stdio.h&gt;
-#include &lt;stdlib.h&gt;
-#include &quot;portaudio.h&quot;
-
-/* #define DITHER_FLAG     (paDitherOff)  */
-#define DITHER_FLAG     (0) /**/
-#define PA_SAMPLE_TYPE  paInt16
-typedef short SAMPLE;
-
-int soundinit_(void)
-{
-  PaError err;
-  err = Pa_Initialize();
-  if( err == paNoError ) {
-    return 0;
-  }
-  else {
-//    Pa_Terminate();
-    fprintf( stderr, &quot;An error occured when initializing the audio stream\n&quot;);
-    fprintf( stderr, &quot;Error number: %d\n&quot;, err );
-    fprintf( stderr, &quot;WSPR will now exit/n&quot;);
-    exit(255);
-  }
-}
-
-int soundexit_(void)
-{
-  Pa_Terminate();
-  return 0;
-}
-
-int soundin_(int *idevin, int *nrate0, short recordedSamples[], 
-	     int *nframes0, int *iqmode)
-{
-    PaStreamParameters inputParameters;
-    PaStream *stream;
-    PaError err;
-    int i;
-    int totalFrames;
-    int numSamples;
-    int numBytes;
-    int num_channels;
-    int nrate;
-    int frames_per_buffer=1024;
-
-    nrate=*nrate0;
-    if(nrate&gt;12000) frames_per_buffer=4096;
-    totalFrames=*nframes0;
-    num_channels=*iqmode + 1;
-    numSamples = totalFrames * num_channels;
-    numBytes = numSamples * sizeof(SAMPLE);
-    for( i=0; i&lt;numSamples; i++ ) 
-      recordedSamples[i] = 0;
-
-    inputParameters.device = *idevin;
-    if(*idevin&lt;0) inputParameters.device = Pa_GetDefaultInputDevice();
-    inputParameters.channelCount = num_channels;
-    inputParameters.sampleFormat = PA_SAMPLE_TYPE;
-    inputParameters.suggestedLatency = 0.4;
-    inputParameters.hostApiSpecificStreamInfo = NULL;
-
-    err = Pa_OpenStream(
-              &amp;stream,
-              &amp;inputParameters,
-              NULL,                  /* &amp;outputParameters, */
-              nrate,
-              frames_per_buffer,
-              paClipOff,
-              NULL, /* no callback, use blocking API */
-              NULL ); /* no callback, so no callback userData */
-    if( err != paNoError ) goto error;
-
-    err = Pa_StartStream( stream );
-    if( err != paNoError ) goto error;
-
-    err = Pa_ReadStream( stream, recordedSamples, totalFrames );
-    if( err != paNoError ) goto error;
-    
-    err = Pa_CloseStream( stream );
-    if( err != paNoError ) goto error;
-    return 0;
-
-error:
-    Pa_Terminate();
-    fprintf( stderr, &quot;An error occured while using the portaudio stream\n&quot; );
-    fprintf( stderr, &quot;Error number: %d\n&quot;, err );
-    fprintf( stderr, &quot;Error message: %s\n&quot;, Pa_GetErrorText( err ) );
-    soundinit_();
-    return -1;
-}
-
-int soundout_(int *idevout, int *nrate0, short recordedSamples[], 
-	      int *nframes0, int *iqmode)
-{
-    PaStreamParameters outputParameters;
-    PaStream *stream;
-    PaError err;
-    int totalFrames;
-    int numSamples;
-    int numBytes;
-    int num_channels;
-    int nrate;
-    int frames_per_buffer=1024;
-
-    nrate=*nrate0;
-    if(nrate&gt;12000) frames_per_buffer=4096;
-    totalFrames=*nframes0;
-    num_channels=*iqmode + 1;
-    numSamples = totalFrames * num_channels;
-    numBytes = numSamples * sizeof(SAMPLE);
-    outputParameters.device = *idevout;
-    if(*idevout&lt;0) outputParameters.device = Pa_GetDefaultOutputDevice();
-    outputParameters.channelCount = num_channels;
-    outputParameters.sampleFormat =  PA_SAMPLE_TYPE;
-    outputParameters.suggestedLatency = 0.4;
-    outputParameters.hostApiSpecificStreamInfo = NULL;
-
-    err = Pa_OpenStream(
-              &amp;stream,
-              NULL, /* no input */
-              &amp;outputParameters,
-              nrate,
-              frames_per_buffer,
-              paClipOff,
-              NULL, /* no callback, use blocking API */
-              NULL ); /* no callback, so no callback userData */
-    if( err != paNoError ) goto error;
-
-    if( stream )
-    {
-        err = Pa_StartStream( stream );
-        if( err != paNoError ) goto error;
-
-        err = Pa_WriteStream( stream, recordedSamples, totalFrames );
-        if( err != paNoError ) goto error;
-
-        err = Pa_CloseStream( stream );
-        if( err != paNoError ) goto error;
-    }
-    return 0;
-
-error:
-    Pa_Terminate();
-    fprintf( stderr, &quot;An error occured while using the portaudio stream\n&quot; );
-    fprintf( stderr, &quot;Error number: %d\n&quot;, err );
-    fprintf( stderr, &quot;Error message: %s\n&quot;, Pa_GetErrorText( err ) );
-    soundinit_();
-    return -1;
-}
-
-void msleep_(int *msec0)
-{
-  Pa_Sleep(*msec0);
-}

Deleted: branches/wsprx/lib/spec162.f90
===================================================================
--- branches/wsprx/lib/spec162.f90	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/spec162.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -1,94 +0,0 @@
-subroutine spec162(c2,jz,appdir,nappdir)
-
-  parameter(NX=500,NY=160)
-  complex c2(65536)
-  complex c(0:255)
-  character*80 appdir,pixmap
-  real s(120,0:255)
-  real ss(0:255)
-  real w(0:255)
-  real savg(0:255)
-  integer*2 a(NX,NY)
-  common/bcom/ntransmitted
-
-  nfft=256
-  twopi=6.2831853
-  pi=0.5*twopi
-  do i=0,nfft-1
-     w(i)=sin(i*pi/nfft)
-  enddo
-
-  nadd=9
-  call zero(s,120*256)
-  call zero(savg,256)
-  istep=nfft/2
-  nsteps=(jz-nfft)/(nadd*istep)
-  pixmap=appdir(:nappdir)//'/pixmap.dat'
-
-  open(16,file=pixmap,access='stream',status='unknown',err=1)
-  read(16,end=1) a
-  go to 2
-1 call zero(a,NX*NY/2)
-
-2 nmove=nsteps+1
-
-  do j=1,NY                 !Move waterfall left
-     do i=1,NX-nmove
-        a(i,j)=a(i+nmove,j)
-     enddo
-     a(NX-nmove+1,j)=255*ntransmitted
-  enddo
-  ntransmitted=0
-
-  i0=-istep+1
-  k=0
-  do n=1,nsteps
-     k=k+1
-     call zero(ss,256)
-     do m=1,nadd
-        i0=i0+istep
-        do i=0,nfft-1
-           c(i)=w(i)*c2(i0+i)
-        enddo
-        call four2a(c,nfft,1,-1,1)
-        do i=0,nfft-1
-           sq=real(c(i))**2 + imag(c(i))**2
-           ss(i)=ss(i) + sq
-           savg(i)=savg(i) + sq
-        enddo
-     enddo
-     call flat3(ss,256,nadd)
-     do i=0,nfft-1
-        s(k,i)=ss(i)
-     enddo
-  enddo
-  kz=k
-
-  gain=40
-  offset=-90.
-  fac=20.0/nadd
-
-  do k=1,kz
-     j=k-kz+NX
-     do i=-80,-1
-        x=fac*s(k,i+nfft)
-        n=0
-        if(x.gt.0.0) n=gain*log10(x) + offset
-        n=min(252,max(0,n))
-        a(j,NY-i-80)=n
-     enddo
-     do i=0,79
-        x=fac*s(k,i)
-        n=0
-        if(x.gt.0.0) n=gain*log10(x) + offset
-        n=min(252,max(0,n))
-        a(j,NY-i-80)=n
-     enddo
-  enddo
-
-  rewind 16
-  write(16) a
-  close(16)
-
-  return
-end subroutine spec162

Deleted: branches/wsprx/lib/wfile5.f90
===================================================================
--- branches/wsprx/lib/wfile5.f90	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/wfile5.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -1,86 +0,0 @@
-subroutine wfile5(iwave,nmax,nfsample,outfile)
-
-! Write a wavefile to disk.
-
-  integer*1 n4 
-  integer*2 iwave(nmax)
-  character*80 outfile
-
-  integer*2 nfmt2,nchan2,nbitsam2,nbytesam2
-  character*4 ariff,awave,afmt,adata
-  integer*1 hdr(44)
-  integer*2 iswap_short
-  common/hdr/ariff,nchunk,awave,afmt,lenfmt,nfmt2,nchan2,               &amp;
-       nsamrate,nbytesec,nbytesam2,nbitsam2,adata,ndata
-  equivalence (hdr,ariff),(nfmt2,n4)
-
-! Generate the header
-  ariff='RIFF'
-  awave='WAVE'
-  afmt='fmt '
-  adata='data'
-  lenfmt=16                             !Rest of this sub-chunk is 16 bytes long
-  nfmt2=1                               !PCM = 1
-  nchan2=1                              !1=mono, 2=stereo
-  nbitsam2=16                           !Bits per sample
-  nsamrate=nfsample
-  nbytesec=nfsample*nchan2*nbitsam2/8   !Bytes per second
-  nbytesam2=nchan2*nbitsam2/8           !Block-align               
-  ndata=nmax*nchan2*nbitsam2/8
-  nbytes=ndata+44
-  nchunk=nbytes-8
-
-  open(12,file=outfile,access='stream',status='unknown')
-  if (n4.ne.nfmt2) then
-     call change_endian                  !Change hdr to little-endian
-     do i=1,nmax
-        iwave(i) = iswap_short(iwave(i))!Change data to little-endian
-     enddo
-  endif
-  write(12) hdr
-  write(12) iwave
-  close(12)
-
-  return
-end subroutine wfile5
-
-subroutine change_endian
-
-  integer*1 hdr(44)
-  integer*2 nfmt2,nchan2,nbitsam2,nbytesam2
-  integer*2 iswap_short
-  character*4 ariff,awave,afmt,adata
-  common/hdr/ariff,nchunk,awave,afmt,lenfmt,nfmt2,nchan2,               &amp;
-       nsamrate,nbytesec,nbytesam2,nbitsam2,adata,ndata
-  equivalence (ariff,hdr)
-
-  nchunk = iswap_int(nchunk)
-  lenfmt = iswap_int(lenfmt)
-  nfmt2 = iswap_short(nfmt2)
-  nchan2 = iswap_short(nchan2)
-  nsamrate = iswap_int(nsamrate)
-  nbytesec = iswap_int(nbytesec)
-  nbytesam2 = iswap_short(nbytesam2)
-  nbitsam2 = iswap_short(nbitsam2)
-  ndata = iswap_int(ndata)
-
-  return
-end subroutine change_endian
-
-integer function iswap_int(idat)
-
-  itemp1 = ior(ishft(idat,24), iand(ishft(idat,8), z'00ff0000'))
-  itemp0 = ior(iand(ishft(idat,-8), z'0000ff00'),                       &amp;
-       iand(ishft(idat,-24),z'000000ff'))
-  iswap_int = ior(itemp1,itemp0)
-      
-end function iswap_int
-
-integer*2 function iswap_short(idat)
-
-  integer*2 idat,m2
-  data m2/255/
-
-  iswap_short = ior(ishft(idat,8), iand(ishft(idat,-8), m2))
-
-end function iswap_short

Modified: branches/wsprx/lib/wqdecode.f90
===================================================================
--- branches/wsprx/lib/wqdecode.f90	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/wqdecode.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -6,7 +6,6 @@
   character*12 callsign
   character*3 cdbm
   character grid4*4,grid6*6,psfx*4
-  logical first
   character*12 dcall(0:N15-1)
   save dcall
 

Deleted: branches/wsprx/lib/wspr0_rx.f90
===================================================================
--- branches/wsprx/lib/wspr0_rx.f90	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/wspr0_rx.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -1,78 +0,0 @@
-subroutine wspr0_rx(nargs,ntr)
-
-!  Read Rx command-line args and the decode MEPT_JT signals from disk
-!  or real-time data.
-
-!  use dfport
-
-  parameter (NMAX=120*12000)                          !Max length of waveform
-  integer*2 iwave(NMAX)                               !Generated waveform
-  integer*1 i1
-  integer*1 hdr(44)
-  integer npr3(162)
-  integer soundin
-  real*8 f0
-  character*20 arg
-  character*80 infile,appdir,thisfile
-  character*6 cfile6,cdate*8,utctime*10
-  equivalence(i1,i4)
-  data appdir/'.'/,nappdir/1/,minsync/1/,nbfo/1500/
-  data npr3/                                          &amp;
-      1,1,0,0,0,0,0,0,1,0,0,0,1,1,1,0,0,0,1,0,        &amp;
-      0,1,0,1,1,1,1,0,0,0,0,0,0,0,1,0,0,1,0,1,        &amp;
-      0,0,0,0,0,0,1,0,1,1,0,0,1,1,0,1,0,0,0,1,        &amp;
-      1,0,1,0,0,0,0,1,1,0,1,0,1,0,1,0,1,0,0,1,        &amp;
-      0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,0,0,0,1,0,        &amp;
-      0,0,0,0,1,0,0,1,0,0,1,1,1,0,1,1,0,0,1,1,        &amp;
-      0,1,0,0,0,1,1,1,0,0,0,0,0,1,0,1,0,0,1,1,        &amp;
-      0,0,0,0,0,0,0,1,1,0,1,0,1,1,0,0,0,1,1,0,        &amp;
-      0,0/
-
-  data nsec0/999999/
-  save
-
-  call getarg(2,arg)
-  read(arg,*) f0
-  nfiles=0
-  if(ntr.eq.0) nfiles=nargs-2
-  npts=114*12000
-
-  if(nfiles.ge.1) then
-     do ifile=1,nfiles
-        call getarg(2+ifile,infile)
-        open(10,file=infile,access='stream',status='old')
-        read(10) hdr
-        read(10) (iwave(i),i=1,npts)
-        close(10)
-        cfile6=infile
-        i1=index(infile,'.')
-        if(i1.ge.2) then
-           i0=max(1,i1-4)
-           cfile6=infile(i0:i1-1)
-        endif
-        call getrms(iwave,npts,ave,rms)
-        call mept162(infile,appdir,nappdir,f0,1,iwave,NMAX,nbfo,ierr)
-     enddo
-  else
-20   nsec=time()
-     isec=mod(nsec,86400)
-     ih=isec/3600
-     im=(isec-ih*3600)/60
-     is=mod(isec,60)
-     is120=mod(isec,120)
-     if(is120.eq.0) then
-        call getutc(cdate,utctime,tsec)
-        thisfile=cdate(3:8)//'_'//utctime(1:4)//'.'//'wav'
-        ierr=soundin(-1,12000,iwave,114*12000,0)
-        npts=114*12000
-        call getrms(iwave,npts,ave,rms)
-        call mept162(thisfile,appdir,nappdir,f0,1,iwave,NMAX,nbfo,ierr)
-        if(ntr.ne.0) go to 999
-     endif
-30   call msleep(100)
-     go to 20
-  endif
-      
-999 return
-end subroutine wspr0_rx
-

Deleted: branches/wsprx/lib/wspr0_tx.f90
===================================================================
--- branches/wsprx/lib/wspr0_tx.f90	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/lib/wspr0_tx.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -1,89 +0,0 @@
-subroutine wspr0_tx(nargs,ntr)
-
-!  Read command-line arguments and generate Tx data for the MEPT_JT mode.
-
-  parameter (NMAX=120*12000)
-  real*8 f0,ftx
-  character*70 arg
-  character*12 call1
-  character*4 grid
-  character*3 cdbm
-  character*22 message
-  character*80 outfile
-  integer*2 iwave(NMAX)
-  integer ptt,soundout
-
-  snrdb=99.
-  outfile=''
-  nfiles=9999
-  call getarg(2,arg)
-  read(arg,*) f0
-  call getarg(3,arg)
-  read(arg,*) ftx
-  ntxdf=nint(1.d6*(ftx-f0))-1500
-  if(abs(ntxdf).gt.100) then
-     print*,'Error: ftx must be above f0 by 1400 to 1600 Hz'
-     stop
-  endif
-  call getarg(4,arg)
-  read(arg,*) nport
-  call getarg(5,call1)
-  call getarg(6,grid)
-  call getarg(7,arg)
-  read(arg,*) ndbm
-  if(nargs.lt.8 .or. ntr.ne.0) go to 10
-  call getarg(8,arg)
-  read(arg,*) snrdb
-  if(nargs.lt.9) go to 10
-  call getarg(9,outfile)
-  read(outfile,1008,err=1) nfiles
-1008  format(i4)
-  outfile=&quot;&quot;
-  go to 10
-1 nfiles=1
-
-10 i1=index(call1,' ')
-  write(cdbm,'(i3)'),ndbm
-  if(cdbm(1:1).eq.' ') cdbm=cdbm(2:)
-  if(cdbm(1:1).eq.' ') cdbm=cdbm(2:)
-  message=call1(1:i1)//grid//' '//cdbm
-  do ifile=1,nfiles
-     if(nfiles.gt.1 .and. nfiles.lt.9999) write(outfile,1010) ifile
-1010 format(i5.5,'.wav')
-     call genmept(message,ntxdf,snrdb,iwave)
-     if(snrdb.eq.11.0) go to 999
-     if(outfile.ne.&quot;&quot;) then
-        call wfile5(iwave,NMAX,12000,outfile)
-        write(*,1020) f0,ftx,snrdb,message,outfile(1:24)
-1020    format(2f11.6,f6.1,2x,a22,2x,a24)
-     else
-20      nsec=time()
-        isec=mod(nsec,86400)
-        ih=isec/3600
-        im=(isec-ih*3600)/60
-        is=mod(isec,60)
-        is120=mod(isec,120)
-        if(is120.eq.0) then
-           if(nport.gt.0) ierr=ptt(nport,junk,1,iptt)
-!           if(ntr.eq.0) write(*,1030) ih,im,is,f0,ftx,message
-!1030       format(i2.2,':',i2.2,':',i2.2,2f11.6,2x,a22)
-           do i=22,1,-1
-              if(message(i:i).ne.' ') go to 25
-           enddo
-25         iz=i
-           write(*,1031) ih,im,ftx,message(1:iz)
-1031       format(2i2.2,9x,f11.6,'  Transmitting &quot;',a,'&quot;')
-           write(14,1032) ih,im,ftx,message(1:iz)
-1032       format(7x,2i2.2,13x,f11.6,'  Transmitting &quot;',a,'&quot;')
-           ierr=soundout(-1,12000,iwave,114*12000,0)
-           if(nport.gt.0) ierr=ptt(nport,junk,0,iptt)
-           if(ntr.ne.0) go to 999
-        endif
-        call msleep(100)
-        go to 20
-     endif
-     if(nfiles.eq.9999) go to 999
-  enddo
-
-999 return
-end subroutine wspr0_tx

Added: branches/wsprx/lib/wsprd.f90
===================================================================
--- branches/wsprx/lib/wsprd.f90	                        (rev 0)
+++ branches/wsprx/lib/wsprd.f90	2013-01-08 14:49:14 UTC (rev 2898)
@@ -0,0 +1,49 @@
+program wsprd
+
+  parameter (NMAX=900*12000)                          !Max length of waveform
+  integer*2 id(NMAX)
+  real*8 f0,dialFreq
+  real*4 ps(-256:256)
+  character*80 infile
+  logical lc2
+  character c2file*14,datetime*11
+  complex c2(65536)
+  data nbfo/1500/
+
+  call getarg(1,infile)
+  open(18,file=infile,access='stream',status='old')
+  lc2=index(infile,'.c2').gt.0
+
+  open(13,file='ALL_WSPR.TXT',status='unknown',position='append')
+  open(14,file='wspr0.out',status='unknown')
+
+  ntrminutes=2
+
+  if(lc2) then
+     read(18) c2file,ntrmin,dialFreq,c2(1:45000)
+     f0=dialFreq
+     ntrminutes=ntrmin
+     npts=60*ntrminutes*12000
+     call mix162a(c2,ps)
+     c2=(2.94127/13.983112)*c2
+  else
+     f0=10.1387
+     ntrminutes=2
+     npts=60*ntrminutes*12000
+     read(18) id(1:22)
+     read(18) id(1:npts)
+     call getrms(id,npts,ave,rms)
+! WSPR-2: mix from nbfo +/- 100 Hz to baseband, downsample by 1/32
+! WSPR-15: mix from (nbfo+112.5) +/- 12.5 Hz to baseband, downsample by 1/256
+     call mix162(id,npts,nbfo,c2,jz,ps)
+  endif
+
+  i1=index(infile,'.wav')
+  if(i1.le.0)   i1=index(infile,'.c2')
+  datetime=infile(i1-11:i1-1)
+  datetime(7:7)=' '
+  call mept162a(datetime,f0,c2,ps,lc2,npts,nbfo)
+  write(*,1100)
+1100 format('&lt;DecodeFinished&gt;')
+    
+end program wsprd

Modified: branches/wsprx/mainwindow.cpp
===================================================================
--- branches/wsprx/mainwindow.cpp	2013-01-08 01:58:11 UTC (rev 2897)
+++ branches/wsprx/mainwindow.cpp	2013-01-08 14:49:14 UTC (rev 2898)
@@ -363,12 +363,16 @@
 
     m_decodedList.clear();
     t2.sprintf(&quot;%.6f &quot;,m_dialFreq);
-//    QString cmnd='&quot;' + m_appDir + '&quot;' + &quot;/wspr0 D &quot; + t2 + m_fname + '&quot;';
-    QString cmnd='&quot;' + m_appDir + '&quot;' + &quot;/wspr0c2 &quot; + m_c2name + '&quot;';
     lab3-&gt;setStyleSheet(&quot;QLabel{background-color:cyan}&quot;);
     lab3-&gt;setText(&quot;Decoding&quot;);
     m_rxdone=true;
     loggit(&quot;Start Decoder&quot;);
+    QString cmnd;
+    if(m_diskData) {
+        cmnd='&quot;' + m_appDir + '&quot;' + &quot;/wsprd &quot; + m_path + '&quot;';
+    } else {
+        cmnd='&quot;' + m_appDir + '&quot;' + &quot;/wsprd &quot; + m_c2name + '&quot;';
+    }
     p1.start(QDir::toNativeSeparators(cmnd));
   }
   soundInThread.m_dataSinkBusy=false;

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002589.html">[WSJT-SVN] r2897 - in branches/wsprx: . lib
</A></li>
	<LI>Next message: <A HREF="002591.html">[WSJT-SVN] r2899 - branches/wsprx
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2590">[ date ]</a>
              <a href="thread.html#2590">[ thread ]</a>
              <a href="subject.html#2590">[ subject ]</a>
              <a href="author.html#2590">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/wsjt-svn">More information about the wsjt-svn
mailing list</a><br>
</body></html>
