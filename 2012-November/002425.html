<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [WSJT-SVN] r2733 - in branches/wsjtx: . lib
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/wsjt-svn/2012-November/index.html" >
   <LINK REL="made" HREF="mailto:wsjt-svn%40lists.berlios.de?Subject=Re%3A%20%5BWSJT-SVN%5D%20r2733%20-%20in%20branches/wsjtx%3A%20.%20lib&In-Reply-To=%3C20121115163414.7F4D355B0C%40scm.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002424.html">
   <LINK REL="Next"  HREF="002426.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[WSJT-SVN] r2733 - in branches/wsjtx: . lib</H1>
    <B>k1jt at scm.berlios.de</B> 
    <A HREF="mailto:wsjt-svn%40lists.berlios.de?Subject=Re%3A%20%5BWSJT-SVN%5D%20r2733%20-%20in%20branches/wsjtx%3A%20.%20lib&In-Reply-To=%3C20121115163414.7F4D355B0C%40scm.berlios.de%3E"
       TITLE="[WSJT-SVN] r2733 - in branches/wsjtx: . lib">k1jt at scm.berlios.de
       </A><BR>
    <I>Thu Nov 15 17:34:14 CET 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="002424.html">[WSJT-SVN] r2732 - in branches/wsjtx: . lib
</A></li>
        <LI>Next message: <A HREF="002426.html">[WSJT-SVN] r2734 - in branches/wsjtx: . lib
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2425">[ date ]</a>
              <a href="thread.html#2425">[ thread ]</a>
              <a href="subject.html#2425">[ subject ]</a>
              <a href="author.html#2425">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: k1jt
Date: 2012-11-15 17:34:14 +0100 (Thu, 15 Nov 2012)
New Revision: 2733

Added:
   branches/wsjtx/lib/jt9code.f90
Modified:
   branches/wsjtx/lib/decoder.f90
   branches/wsjtx/lib/packmsg.f
   branches/wsjtx/lib/peakdt9.f90
   branches/wsjtx/lib/redsync.f90
   branches/wsjtx/mainwindow.cpp
Log:
Tweaks to jt9code.
Fix reports generated by double-click on callsign.
Collapse consecutive spaces in message to a single space.
Look at best element in ccfred first; then zap nearby ones; then repeat.
Display sqrt(red(i)) in waterfall.
Step by 4 (or 2) in peakdt9, then zero in on the peak.


Modified: branches/wsjtx/lib/decoder.f90
===================================================================
--- branches/wsjtx/lib/decoder.f90	2012-11-15 13:37:40 UTC (rev 2732)
+++ branches/wsjtx/lib/decoder.f90	2012-11-15 16:34:14 UTC (rev 2733)
@@ -11,6 +11,7 @@
   real*4 ccfred(NSMAX)
   integer*1 i1SoftSymbols(207)
   integer*2 id2
+  integer ii(1)
   complex c0(NDMAX),c00(NDMAX)
   common/jt9com/ss0(184,NSMAX),savg(NSMAX),id2(NMAX),nutc0,ndiskdat,    &amp;
        ntr,nfqso,newdat,npts80,nfb,ntol,kin,nsynced,ndecoded
@@ -86,39 +87,44 @@
   fgood=0.
   df8=1500.0/(nsps/8)
   sbest=0.
-  do i=ia,ib
-     f=(i-1)*df3
-     if((i.eq.ipk .or. ccfred(i).ge.3.0) .and. f.gt.fgood+10.0*df8) then
-        call timer('spec9   ',0)
-        call spec9(c0,npts8,nsps,f,fpk,xdt,snr,i1SoftSymbols)
-        call timer('spec9   ',1)
 
-        call timer('decode9 ',0)
-        call decode9(i1SoftSymbols,limit,nlim,msg)
-        call timer('decode9 ',1)
-        sync=ccfred(i) - 2.0
-        if(sync.lt.0.0) sync=0.0
-        nsync=sync
-        if(nsync.gt.10) nsync=10
-        nsnr=nint(snr)
-        drift=0.0
+10 continue
+  ii=maxloc(ccfred(ia:ib))
+  i=ii(1) + ia - 1
+  f=(i-1)*df3
 
-        if(ccfred(i).gt.sbest .and. fgood.eq.0.0) then
-           sbest=ccfred(i)
-           write(line,fmt) nutc,nsync,nsnr,xdt,1000.0+fpk,drift
-           if(nsync.gt.0) nsynced=1
-        endif
+  if((i.eq.ipk .or. ccfred(i).ge.3.0) .and. abs(f-fgood).gt.10.0*df8) then
+     call timer('spec9   ',0)
+     call spec9(c0,npts8,nsps,f,fpk,xdt,snr,i1SoftSymbols)
+     call timer('spec9   ',1)
 
-        if(msg.ne.'                      ') then
-           write(13,fmt) nutc,nsync,nsnr,xdt,1000.0+fpk,drift,msg
-           write(14,fmt) nutc,nsync,nsnr,xdt,1000.0+fpk,drift,msg
-           fgood=f
-           nsynced=1
-           ndecoded=1
-        endif
+     call timer('decode9 ',0)
+     call decode9(i1SoftSymbols,limit,nlim,msg)
+     call timer('decode9 ',1)
+     sync=ccfred(i) - 2.0
+     if(sync.lt.0.0) sync=0.0
+     nsync=sync
+     if(nsync.gt.10) nsync=10
+     nsnr=nint(snr)
+     drift=0.0
+
+     if(ccfred(i).gt.sbest .and. fgood.eq.0.0) then
+        sbest=ccfred(i)
+        write(line,fmt) nutc,nsync,nsnr,xdt,1000.0+fpk,drift
+        if(nsync.gt.0) nsynced=1
      endif
-  enddo
 
+     if(msg.ne.'                      ') then
+        write(13,fmt) nutc,nsync,nsnr,xdt,1000.0+fpk,drift,msg
+        write(14,fmt) nutc,nsync,nsnr,xdt,1000.0+fpk,drift,msg
+        fgood=f
+        nsynced=1
+        ndecoded=1
+     endif
+  endif
+  ccfred(i-10:i+10)=0.
+  if(maxval(ccfred(ia:ib)).gt.3.0) go to 10
+
   if(fgood.eq.0.0) then
      write(13,1020) line
      write(14,1020) line

Added: branches/wsjtx/lib/jt9code.f90
===================================================================
--- branches/wsjtx/lib/jt9code.f90	                        (rev 0)
+++ branches/wsjtx/lib/jt9code.f90	2012-11-15 16:34:14 UTC (rev 2733)
@@ -0,0 +1,35 @@
+program jt9code
+
+! Generate simulated data for testing of WSJT-X
+
+  parameter (NMAX=1800*12000)
+  character msg*22,msg0*22,decoded*22
+
+  integer*4 i4tone(85)             !Channel symbols (values 0-8)
+  integer*4 i4data(69)
+  integer*4 i4DataSymNoGray(69)    !Data Symbols, values 0-7
+  integer*1 i1ScrambledBits(207)   !Unpacked bits, scrambled order
+  integer*1 i1Bits(207)            !Encoded information-carrying bits
+  integer*1 i1SoftSymbols(207)
+  integer*1 i1
+  equivalence (i1,i4)
+  include 'jt9sync.f90'
+  common/acom/dat(NMAX),iwave(NMAX)
+
+  nargs=iargc()
+  if(nargs.ne.1) then
+     print*,'Usage: jt9code &quot;message&quot;'
+     go to 999
+  endif
+
+  call getarg(1,msg0)
+  write(*,1000) msg0
+1000 format('Message:',3x,a22)
+  msg=msg0
+  call genjt9(msg,decoded,i4tone)               !Encode message into tone #s
+  write(*,1002) i4tone
+1002 format('Channel symbols:'/(30i2))
+  write(*,1004) decoded
+1004 format('Decoded message:',1x,a22)
+
+999 end program jt9code

Modified: branches/wsjtx/lib/packmsg.f
===================================================================
--- branches/wsjtx/lib/packmsg.f	2012-11-15 13:37:40 UTC (rev 2732)
+++ branches/wsjtx/lib/packmsg.f	2012-11-15 16:34:14 UTC (rev 2733)
@@ -7,17 +7,23 @@
       character*12 c1,c2
       character*4 c3
       character*6 grid6
-c      character*3 dxcc                  !Where is DXCC implemented?
       logical text1,text2,text3
 
 C  Convert all letters to upper case
       do i=1,22
          if(msg(i:i).ge.'a' .and. msg(i:i).le.'z') 
      +     msg(i:i)= char(ichar(msg(i:i))+ichar('A')-ichar('a'))
+         if(msg(i:i).ne.' ') iz=i
       enddo
+      do iter=1,5                           !Collapse multiple blanks into one
+         ib2=index(msg(1:iz),'  ')
+         if(ib2.lt.1) go to 5
+         msg=msg(1:ib2)//msg(ib2+2:)
+         iz=iz-1
+      enddo
 
 C  See if it's a CQ message
-      if(msg(1:3).eq.'CQ ') then
+ 5    if(msg(1:3).eq.'CQ ') then
          i=3
 C  ... and if so, does it have a reply frequency?
          if(msg(4:4).ge.'0' .and. msg(4:4).le.'9' .and. 

Modified: branches/wsjtx/lib/peakdt9.f90
===================================================================
--- branches/wsjtx/lib/peakdt9.f90	2012-11-15 13:37:40 UTC (rev 2732)
+++ branches/wsjtx/lib/peakdt9.f90	2012-11-15 16:34:14 UTC (rev 2733)
@@ -11,7 +11,14 @@
 
   f0=foffset
   dphi=twopi*f0/1500.0
-  do idt=-idtmax,idtmax
+
+  idtstep=4
+  if(idtmax.lt.30) idtstep=2
+  if(idtmax.lt.15) idtstep=1
+  idt1=-idtmax
+  idt2=idtmax
+
+10 do idt=idt1,idt2,idtstep
      i0=istart + 0.0625*nsps8*idt
     sum=0.
      do j=1,16
@@ -32,5 +39,12 @@
      endif
   enddo
 
+  if(idtstep.gt.1) then
+     idtstep=1
+     idt1=idtpk-1
+     idt2=idtpk+1
+     go to 10
+  endif
+
   return
 end subroutine peakdt9

Modified: branches/wsjtx/lib/redsync.f90
===================================================================
--- branches/wsjtx/lib/redsync.f90	2012-11-15 13:37:40 UTC (rev 2732)
+++ branches/wsjtx/lib/redsync.f90	2012-11-15 16:34:14 UTC (rev 2733)
@@ -31,6 +31,7 @@
   smax=0.
   do i=1,iz
 !     red(i)=0.3*db(red(i))
+     red(i)=sqrt(red(i))
      smax=max(smax,red(i))
   enddo
   h=10.

Modified: branches/wsjtx/mainwindow.cpp
===================================================================
--- branches/wsjtx/mainwindow.cpp	2012-11-15 13:37:40 UTC (rev 2732)
+++ branches/wsjtx/mainwindow.cpp	2012-11-15 16:34:14 UTC (rev 2733)
@@ -1133,16 +1133,17 @@
   ui-&gt;dxCallEntry-&gt;setText(hiscall);
   QString t = ui-&gt;decodedTextBrowser-&gt;toPlainText();   //Full contents
   int i2=ui-&gt;decodedTextBrowser-&gt;textCursor().position();
-  int i3=t.mid(i2,99).indexOf(&quot;\n&quot;)-1;   //points to last char of line
-  QString t1 = t.mid(0,i3);              //contents up to \n on selected line
+  QString t1 = t.mid(0,i2);              //contents up to \n on selected line
   int i1=t1.lastIndexOf(&quot;\n&quot;) + 1;       //points to first char of line
-  QString t2 = t1.mid(i1,i3-i1);         //selected line
+  QString t2 = t1.mid(i1,i2-i1);         //selected line
   int n = 60*t2.mid(0,2).toInt() + t2.mid(2,2).toInt();
   int nmod=n%(m_TRperiod/30);
   m_txFirst=(nmod!=0);
   ui-&gt;txFirstCheckBox-&gt;setChecked(m_txFirst);
   QString rpt=t2.mid(10,3);
   if(rpt.indexOf(&quot; &quot;)==0) rpt=rpt.mid(1,2);
+  if(rpt.toInt()&gt;-1) rpt=&quot;-01&quot;;
+  if(rpt.toInt()&lt;-50) rpt=&quot;-50&quot;;
   if(ctrl) {
     int i4=t.mid(i2,20).indexOf(&quot; &quot;);
     QString hisgrid=t.mid(i2,20).mid(i4+1,4);

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002424.html">[WSJT-SVN] r2732 - in branches/wsjtx: . lib
</A></li>
	<LI>Next message: <A HREF="002426.html">[WSJT-SVN] r2734 - in branches/wsjtx: . lib
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2425">[ date ]</a>
              <a href="thread.html#2425">[ thread ]</a>
              <a href="subject.html#2425">[ subject ]</a>
              <a href="author.html#2425">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/wsjt-svn">More information about the wsjt-svn
mailing list</a><br>
</body></html>
